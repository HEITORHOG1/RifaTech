@page "/rifas/criar"
@using System.Net.Http.Json
@using RifaTech.DTOs.DTOs
@using RifaTech.UI.Shared.Config
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Criar Rifa - RifaTech</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-2" />
        Criar Nova Rifa
    </MudText>

    <MudPaper Elevation="3" Class="pa-6">
        <EditForm Model="_rifa" OnValidSubmit="HandleSubmitAsync">
            <DataAnnotationsValidator />

            <MudGrid>
                <MudItem xs="12">
                    <MudTextField T="string" @bind-Value="_rifa.Name"
                                  Label="Nome da Rifa" Required="true"
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField T="string" @bind-Value="_rifa.Description"
                                  Label="Descrição" Lines="3"
                                  Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField T="decimal" @bind-Value="_rifa.TicketPrice"
                                     Label="Preço do Ticket (R$)" Min="0.01M"
                                     Format="N2" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField T="decimal" @bind-Value="_rifa.PriceValue"
                                     Label="Valor do Prêmio (R$)" Min="0.01M"
                                     Format="N2" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField T="int" @bind-Value="_rifa.MinTickets"
                                     Label="Mínimo de Tickets" Min="1"
                                     Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField T="int" @bind-Value="_rifa.MaxTickets"
                                     Label="Máximo de Tickets" Min="1"
                                     Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudDatePicker Label="Data de Início" @bind-Date="_startDate"
                                   Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudDatePicker Label="Data do Sorteio" @bind-Date="_drawDate"
                                   Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12">
                    <MudFileUpload T="IBrowserFile" Accept=".png,.jpg,.jpeg,.gif,.webp"
                                   FilesChanged="OnImageSelectedAsync">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.Image">
                                Selecionar Imagem
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                    @if (!string.IsNullOrEmpty(_rifa.Base64Img))
                    {
                        <MudImage Src="@($"data:image/png;base64,{_rifa.Base64Img}")"
                                  Alt="Preview" Width="200" Class="mt-2 rounded" />
                    }
                </MudItem>

                <MudItem xs="12" Class="d-flex justify-end gap-2">
                    <MudButton Variant="Variant.Outlined" Color="Color.Default"
                               Href="/rifas">Cancelar</MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary"
                               ButtonType="ButtonType.Submit" Disabled="_saving"
                               StartIcon="@Icons.Material.Filled.Save">
                        @if (_saving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        }
                        Criar Rifa
                    </MudButton>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private RifaDTO _rifa = new()
    {
        MinTickets = 10,
        MaxTickets = 100,
        TicketPrice = 10.00m,
        PriceValue = 1000.00m
    };
    private DateTime? _startDate = DateTime.Today;
    private DateTime? _drawDate = DateTime.Today.AddDays(30);
    private bool _saving = false;

    private async Task OnImageSelectedAsync(IBrowserFile file)
    {
        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            _rifa.Base64Img = Convert.ToBase64String(ms.ToArray());
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar imagem: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleSubmitAsync()
    {
        try
        {
            _saving = true;

            _rifa.StartDate = _startDate ?? DateTime.Today;
            _rifa.DrawDateTime = _drawDate ?? DateTime.Today.AddDays(30);
            _rifa.EndDate = _rifa.DrawDateTime;

            var response = await Http.PostAsJsonAsync(AppConfig.Api.Endpoints.Rifas, _rifa);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Rifa criada com sucesso!", Severity.Success);
                Navigation.NavigateTo("/rifas");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Erro ao criar rifa: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }
}
