@page "/login"
@using Microsoft.AspNetCore.Components.Authorization
@using MudBlazor
@using RifaTech.DTOs.DTOs
@using System.Net.Http.Json
@using Microsoft.Extensions.Logging
@using RifaTech.UI.Shared.Models
@using RifaTech.UI.Shared.Services
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<Login> Logger
@inject ILocalStorageService LocalStorage

<PageTitle>Login - RifaTech</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Elevation="3" Class="pa-8">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-6">Entre no RifaTech</MudText>

        <MudTabs Elevation="0" Centered="true" Color="Color.Primary" Class="mt-4">
            <MudTabPanel Text="Login" Icon="@Icons.Material.Filled.Login">
                <EditForm Model="_loginModel" OnValidSubmit="ProcessLogin" Class="mt-4">
                    <DataAnnotationsValidator />

                    <MudTextField T="string"
                                  Label="Email"
                                  Variant="Variant.Outlined"
                                  @bind-Value="_loginModel.Email"
                                  For="@(() => _loginModel.Email)"
                                  Immediate="true"
                                  Required="true"
                                  RequiredError="Email é obrigatório"
                                  Class="mb-4" />

                    <MudTextField T="string"
                                  Label="Senha"
                                  Variant="Variant.Outlined"
                                  @bind-Value="_loginModel.Password"
                                  For="@(() => _loginModel.Password)"
                                  Immediate="true"
                                  Required="true"
                                  RequiredError="Senha é obrigatória"
                                  InputType="@(_showPassword? InputType.Text: InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showPassword? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  AdornmentClick="() => _showPassword = !_showPassword"
                                  Class="mb-4" />

                    <div class="d-flex justify-space-between align-center mb-6">
                        <MudCheckBox T="bool" @bind-Checked="_rememberMe" Label="Lembrar de mim" />
                        <MudLink Href="/esqueci-senha">Esqueci minha senha</MudLink>
                    </div>

                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               FullWidth="true"
                               Disabled="@_processing">
                        @if (_processing)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Processando</MudText>
                        }
                        else
                        {
                            <MudText>Entrar</MudText>
                        }
                    </MudButton>
                </EditForm>
            </MudTabPanel>

            <MudTabPanel Text="Cadastro" Icon="@Icons.Material.Filled.PersonAdd">
                <EditForm Model="_registerModel" OnValidSubmit="ProcessRegistration" Class="mt-4">
                    <DataAnnotationsValidator />

                    <MudTextField T="string"
                                  Label="Nome Completo"
                                  Variant="Variant.Outlined"
                                  @bind-Value="_registerModel.Name"
                                  For="@(() => _registerModel.Name)"
                                  Immediate="true"
                                  Required="true"
                                  RequiredError="Nome é obrigatório"
                                  Class="mb-4" />

                    <MudTextField T="string"
                                  Label="Email"
                                  Variant="Variant.Outlined"
                                  @bind-Value="_registerModel.Email"
                                  For="@(() => _registerModel.Email)"
                                  Immediate="true"
                                  Required="true"
                                  RequiredError="Email é obrigatório"
                                  Class="mb-4" />

                    <MudTextField T="string"
                                  Label="CPF"
                                  Variant="Variant.Outlined"
                                  @bind-Value="_registerModel.CPF"
                                  For="@(() => _registerModel.CPF)"
                                  Immediate="true"
                                  Required="true"
                                  RequiredError="CPF é obrigatório"
                                  Class="mb-4" />

                    <MudTextField T="string"
                                  Label="Senha"
                                  Variant="Variant.Outlined"
                                  @bind-Value="_registerModel.Password"
                                  For="@(() => _registerModel.Password)"
                                  Immediate="true"
                                  Required="true"
                                  RequiredError="Senha é obrigatória"
                                  InputType="@(_showPassword? InputType.Text: InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_showPassword? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  AdornmentClick="() => _showPassword = !_showPassword"
                                  Class="mb-4" />

                    <MudTextField T="string"
                                  Label="Confirmar Senha"
                                  Variant="Variant.Outlined"
                                  @bind-Value="_registerModel.ConfirmPassword"
                                  For="@(() => _registerModel.ConfirmPassword)"
                                  Immediate="true"
                                  Required="true"
                                  RequiredError="Confirmação de senha é obrigatória"
                                  InputType="@(_showPassword? InputType.Text: InputType.Password)"
                                  Class="mb-6" />

                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Size="Size.Large"
                               FullWidth="true"
                               Disabled="@_processing">
                        @if (_processing)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Processando</MudText>
                        }
                        else
                        {
                            <MudText>Cadastrar</MudText>
                        }
                    </MudButton>
                </EditForm>
            </MudTabPanel>
        </MudTabs>

        <MudDivider Class="mt-8 mb-4" />

        <MudText Align="Align.Center" Typo="Typo.body2" Class="mud-text-secondary">
            Ao fazer login você concorda com nossos
            <MudLink Href="/termos">Termos de Uso</MudLink> e
            <MudLink Href="/privacidade">Política de Privacidade</MudLink>.
        </MudText>

        @if (_debugMode)
        {
            <MudExpansionPanel Class="mt-4">
                <TitleContent>
                    <MudText Typo="Typo.body2">Informações de depuração</MudText>
                </TitleContent>
                <ChildContent>
                    <MudText Typo="Typo.caption">Status de Login: @_loginStatus</MudText>
                    <MudText Typo="Typo.caption">Token: @_debugToken?.Substring(0, Math.Min(50, _debugToken?.Length ?? 0))...</MudText>
                    <MudText Typo="Typo.caption">Role: @_userRole</MudText>
                    <MudText Typo="Typo.caption">IsAdmin: @_isAdmin</MudText>
                </ChildContent>
            </MudExpansionPanel>
        }
    </MudPaper>

    @if (_debugMode)
    {
        <MudPaper Class="mt-4 pa-4">
            <MudButton Variant="Variant.Outlined" OnClick="ToggleDebugMode">
                @(_debugMode ? "Ocultar Debug" : "Mostrar Debug")
            </MudButton>

            @if (_debugError != null)
            {
                <MudAlert Severity="Severity.Error" Class="mt-2">@_debugError</MudAlert>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    private LoginDTO _loginModel = new();
    private UserDTO _registerModel = new();
    private bool _showPassword = false;
    private bool _rememberMe = false;
    private bool _processing = false;

    // Debug information
    private bool _debugMode = false;
    private string _loginStatus = "Não iniciado";
    private string _debugToken = null;
    private string _userRole = "Nenhum";
    private bool _isAdmin = false;
    private string _debugError = null;

    protected override async Task OnInitializedAsync()
    {
        // Verificar se já tem email salvo para lembrar
        var savedEmail = await LocalStorage.GetItemAsync<string>("email");
        if (!string.IsNullOrEmpty(savedEmail))
        {
            _loginModel.Email = savedEmail;
            _rememberMe = true;
        }

        // Em ambiente de desenvolvimento, podemos ativar o modo debug
#if DEBUG
        _debugMode = true;
#endif
    }

    private void ToggleDebugMode()
    {
        _debugMode = !_debugMode;
    }

    private async Task ProcessLogin()
    {
        _processing = true;
        _loginStatus = "Iniciando login";
        _debugError = null;

        try
        {
            Logger.LogInformation($"Tentando login para usuário: {_loginModel.Email}");

            var response = await Http.PostAsJsonAsync("api/manage/login", _loginModel);

            if (response.IsSuccessStatusCode)
            {
                _loginStatus = "Resposta recebida com sucesso";
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();

                if (result.Flag)
                {
                    _loginStatus = "Login bem-sucedido";
                    _debugToken = result.Token;
                    _userRole = result.Role;
                    _isAdmin = result.EhAdmin;

                    Logger.LogInformation($"Login bem-sucedido. Token recebido. IsAdmin: {result.EhAdmin}, Role: {result.Role}");

                    // Salvar informações no localStorage
                    await LocalStorage.SetItemAsync("authToken", result.Token);
                    await LocalStorage.SetItemAsync("refreshToken", result.RefreshToken);

                    // Salvar informações de admin para uso posterior
                    await LocalStorage.SetItemAsync("userRole", result.Role);
                    await LocalStorage.SetItemAsync("isAdmin", result.EhAdmin);
                    await LocalStorage.SetItemAsync("userId", result.Id);

                    if (_rememberMe)
                    {
                        await LocalStorage.SetItemAsync("email", _loginModel.Email);
                    }

                    // Notificar o provedor de autenticação
                    if (AuthStateProvider is CustomAuthStateProvider authProvider)
                    {
                        _loginStatus = "Notificando provedor de autenticação";
                        authProvider.NotifyUserAuthentication(result.Token);
                    }

                    Snackbar.Add("Login realizado com sucesso!", Severity.Success);

                    // Redirecionar para a página apropriada
                    if (result.EhAdmin)
                    {
                        _loginStatus = "Redirecionando para área administrativa";
                        Navigation.NavigateTo("/admin/dashboard");
                    }
                    else
                    {
                        _loginStatus = "Redirecionando para área do usuário";
                        Navigation.NavigateTo("/");
                    }
                }
                else
                {
                    _loginStatus = $"Falha no login: {result.Message}";
                    _debugError = result.Message;
                    Logger.LogWarning($"Falha no login: {result.Message}");
                    Snackbar.Add(result.Message, Severity.Error);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                _loginStatus = $"Erro na requisição: {response.StatusCode}";
                _debugError = error;
                Logger.LogError($"Erro na requisição de login. Status: {response.StatusCode}, Erro: {error}");
                Snackbar.Add($"Erro ao realizar login: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            _loginStatus = $"Exceção: {ex.Message}";
            _debugError = ex.ToString();
            Logger.LogError(ex, "Erro ao processar login");
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }

    private async Task ProcessRegistration()
    {
        _processing = true;

        try
        {
            Logger.LogInformation($"Tentando registrar usuário: {_registerModel.Email}");

            var response = await Http.PostAsJsonAsync("api/manage/register", _registerModel);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<dynamic>();
                Logger.LogInformation("Cadastro realizado com sucesso");
                Snackbar.Add("Cadastro realizado com sucesso! Faça login para continuar.", Severity.Success);

                // Limpar formulário e mudar para a aba de login
                _registerModel = new UserDTO();
                await InvokeAsync(StateHasChanged);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Logger.LogError($"Erro no registro. Status: {response.StatusCode}, Erro: {error}");
                Snackbar.Add($"Erro ao realizar cadastro: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao processar registro");
            Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }
}