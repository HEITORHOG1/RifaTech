@page "/admin/sorteios"
@using System.Net.Http.Json
@using RifaTech.DTOs.DTOs
@using RifaTech.UI.Shared.Config
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<PageTitle>Sorteios - Admin RifaTech</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Casino" Class="mr-2" />
        Gerenciar Sorteios
    </MudText>

    <!-- Próximos Sorteios -->
    <MudText Typo="Typo.h5" Class="mb-3">
        <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-1" />
        Próximos Sorteios
    </MudText>

    @if (_loading)
    {
        <MudContainer Class="d-flex flex-column align-center justify-center my-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            <MudText Typo="Typo.body1" Class="mt-4">Carregando sorteios...</MudText>
        </MudContainer>
    }
    else
    {
        @if (_upcomingDraws?.Any() == true)
        {
            <MudGrid Class="mb-6">
                @foreach (var draw in _upcomingDraws)
                {
                    <MudItem xs="12" md="6" lg="4">
                        <MudCard Elevation="3">
                            <MudCardContent>
                                <MudText Typo="Typo.h6">@(draw.Rifa?.Name ?? "Rifa")</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                    @draw.DrawDateTime.ToString("dd/MM/yyyy HH:mm")
                                </MudText>
                                @if (!string.IsNullOrEmpty(draw.WinningNumber))
                                {
                                    <MudChip T="string" Color="Color.Success" Class="mt-2">
                                        Vencedor: #@draw.WinningNumber
                                    </MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Info" Class="mt-2">Agendado</MudChip>
                                }
                            </MudCardContent>
                            <MudCardActions>
                                @if (string.IsNullOrEmpty(draw.WinningNumber) && draw.RifaId != Guid.Empty)
                                {
                                    <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                                               OnClick="@(() => ExecuteDrawAsync(draw.RifaId))"
                                               StartIcon="@Icons.Material.Filled.PlayArrow">
                                        Realizar Sorteio
                                    </MudButton>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small"
                                               OnClick="@(() => CancelDrawAsync(draw.RifaId))"
                                               StartIcon="@Icons.Material.Filled.Cancel">
                                        Cancelar
                                    </MudButton>
                                }
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Class="mb-6">Nenhum sorteio agendado.</MudAlert>
        }

        <!-- Histórico de Sorteios -->
        <MudText Typo="Typo.h5" Class="mb-3 mt-4">
            <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-1" />
            Histórico de Sorteios
        </MudText>

        @if (_drawHistory?.Any() == true)
        {
            <MudTable Items="_drawHistory" Hover="true" Striped="true" Dense="true" Elevation="3">
                <HeaderContent>
                    <MudTh>Rifa</MudTh>
                    <MudTh>Data do Sorteio</MudTh>
                    <MudTh>Número Vencedor</MudTh>
                    <MudTh>Status</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Rifa">@(context.Rifa?.Name ?? "—")</MudTd>
                    <MudTd DataLabel="Data">@context.DrawDateTime.ToString("dd/MM/yyyy HH:mm")</MudTd>
                    <MudTd DataLabel="Vencedor">
                        @if (!string.IsNullOrEmpty(context.WinningNumber))
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">#@context.WinningNumber</MudChip>
                        }
                        else
                        {
                            <MudText>—</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Status">
                        @if (!string.IsNullOrEmpty(context.WinningNumber))
                        {
                            <MudChip T="string" Color="Color.Success" Size="Size.Small">Realizado</MudChip>
                        }
                        else if (context.DrawDateTime > DateTime.Now)
                        {
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">Agendado</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Color="Color.Warning" Size="Size.Small">Pendente</MudChip>
                        }
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" />
                </PagerContent>
            </MudTable>
        }
        else
        {
            <MudAlert Severity="Severity.Info">Nenhum sorteio realizado ainda.</MudAlert>
        }
    }
</MudContainer>

@code {
    private List<DrawDTO>? _upcomingDraws;
    private List<DrawDTO>? _drawHistory;
    private bool _loading = true;
    private CancellationTokenSource _cts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _loading = true;
            var allDraws = await Http.GetFromJsonAsync<List<DrawDTO>>(
                "/draws", _cts.Token) ?? new List<DrawDTO>();

            _upcomingDraws = allDraws.Where(d => string.IsNullOrEmpty(d.WinningNumber) && d.DrawDateTime > DateTime.Now)
                .OrderBy(d => d.DrawDateTime).ToList();

            _drawHistory = allDraws.Where(d => !string.IsNullOrEmpty(d.WinningNumber) || d.DrawDateTime <= DateTime.Now)
                .OrderByDescending(d => d.DrawDateTime).ToList();
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar sorteios: {ex.Message}", Severity.Error);
            _upcomingDraws = new();
            _drawHistory = new();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ExecuteDrawAsync(Guid rifaId)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirmar Sorteio",
            "Deseja realizar o sorteio agora? Esta ação não pode ser desfeita.",
            yesText: "Sim, sortear!", cancelText: "Cancelar");

        if (confirm == true)
        {
            try
            {
                var response = await Http.PostAsync($"/admin/draws/execute/{rifaId}", null);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Sorteio realizado com sucesso!", Severity.Success);
                    await LoadDataAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Snackbar.Add($"Erro: {error}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CancelDrawAsync(Guid rifaId)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Cancelar Sorteio",
            "Tem certeza que deseja cancelar este sorteio?",
            yesText: "Sim, cancelar", cancelText: "Não");

        if (confirm == true)
        {
            try
            {
                var response = await Http.PostAsync($"/admin/draws/cancel/{rifaId}", null);
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Sorteio cancelado.", Severity.Warning);
                    await LoadDataAsync();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Snackbar.Add($"Erro: {error}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro: {ex.Message}", Severity.Error);
            }
        }
    }

    public void Dispose() => _cts.Cancel();
}
